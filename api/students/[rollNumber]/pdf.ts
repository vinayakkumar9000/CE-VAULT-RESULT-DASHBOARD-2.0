import type { VercelRequest, VercelResponse } from '@vercel/node';
import connectToDatabase from '../../../lib/db.js';
import Student from '../../../models/Student.js';
import PDFDocument from 'pdfkit';
import { Readable } from 'stream';

export const maxDuration = 60;

export default async function handler(
  req: VercelRequest,
  res: VercelResponse
) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const db = await connectToDatabase();
    if (!db) {
      return res.status(503).json({
        error: 'Database not connected. Please configure MONGODB_URI.',
      });
    }

    const { rollNumber } = req.query;

    if (!rollNumber || typeof rollNumber !== 'string') {
      return res.status(400).json({ error: 'rollNumber is required' });
    }

    // Find student by roll number
    const student = await Student.findOne({
      rollNumber: { $regex: `^${rollNumber}$`, $options: 'i' },
    });

    if (!student) {
      return res.status(404).json({ error: 'Student not found' });
    }

    // Generate PDF
    const doc = new PDFDocument({ margin: 50, size: 'A4' });
    const chunks: Buffer[] = [];

    doc.on('data', (chunk) => chunks.push(chunk));
    doc.on('end', () => {
      const pdfBuffer = Buffer.concat(chunks);
      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader(
        'Content-Disposition',
        `attachment; filename="result_${student.rollNumber}.pdf"`
      );
      res.status(200).send(pdfBuffer);
    });

    // PDF Content
    doc.fontSize(20).text('CE VAULT - Student Result', { align: 'center' });
    doc.moveDown();

    doc.fontSize(14).text(`Roll Number: ${student.rollNumber}`);
    doc.text(`Name: ${student.name}`);
    doc.text(`Semester: ${student.semester}`);
    doc.text(`Branch: ${student.branch}`);
    doc.moveDown();

    doc.fontSize(16).text('Subject Details:', { underline: true });
    doc.moveDown(0.5);

    // Table header
    doc.fontSize(10);
    doc.text('Code', 50, doc.y);
    doc.text('Subject Name', 120, doc.y);
    doc.text('Marks', 350, doc.y);
    doc.text('Credits', 420, doc.y);
    doc.moveDown(0.3);

    // Draw line
    doc.moveTo(50, doc.y).lineTo(500, doc.y).stroke();
    doc.moveDown(0.3);

    // Subject rows
    student.subjects.forEach((subject) => {
      const y = doc.y;
      doc.text(subject.code, 50, y);
      doc.text(subject.name, 120, y, { width: 220 });
      doc.text(subject.marks.toString(), 350, y);
      doc.text(subject.credits.toString(), 420, y);
      doc.moveDown(0.5);
    });

    doc.moveDown();
    doc.fontSize(14);
    doc.text(`SGPA: ${student.sgpa.toFixed(2)}`, { align: 'right' });
    if (student.cgpa) {
      doc.text(`CGPA: ${student.cgpa.toFixed(2)}`, { align: 'right' });
    }

    doc.moveDown(2);
    doc.fontSize(10).text('Generated by CE VAULT Result Portal', {
      align: 'center',
    });
    doc.text(`Date: ${new Date().toLocaleDateString()}`, { align: 'center' });

    doc.end();
  } catch (err: any) {
    console.error('PDF generation error:', err);
    return res.status(500).json({
      error: String(err?.message || err),
    });
  }
}
